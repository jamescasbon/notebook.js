(function(){var h,k,e,j,i,c;e="undefined"!==typeof exports&&null!==exports?exports:this;e=e.NotebookJS=null!=(k=e.NotebookJS)?k:{};e.util=null!=(c=e.util)?c:{};h=jQuery;j=function(a){var c,f,l,b,p,g,n,e;if("undefined"!==typeof atob&&null!==atob)return atob(a);c=n=0;e=[];if(!a)return a;for(a+="";n<a.length;)l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),
g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(n++)),f=l<<18|b<<12|p<<6|g,l=f>>16&255,b=f>>8&255,f&=255,64===p?e[c++]=String.fromCharCode(l):64===g?e[c++]=String.fromCharCode(l,b):e[c++]=String.fromCharCode(l,b,f);return e.join("")};i=function(a){var c,f,l,b,p,g,n;if("undefined"!==typeof btoa&&null!==btoa)return btoa(a);c=g=0;n=[];if(!a)return a;for(a+="";g<a.length;)l=a.charCodeAt(g++),b=a.charCodeAt(g++),p=a.charCodeAt(g++),f=l<<16|b<<8|p,l=f>>18&63,b=f>>
12&63,p=f>>6&63,f&=63,n[c++]="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(l)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(b)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(p)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f);c=n.join("");a=a.length%3;return(a?c.slice(0,a-3):c)+"===".slice(a||3)};k=function(){function a(a){var c=this;this.element=h('<div class="modal">\n  <div class="modal-inner">\n    <a class="close">&times;</a>\n    <div class="modal-content"></div>\n  </div>\n</div>');
this.element.appendTo(document.body);this.element.on("click",".close",function(){return c.close()});a&&this.setContent(a)}a.prototype.setContent=function(a){return this.element.find(".modal-content").html(a)};a.prototype.close=function(){return this.element.remove()};return a}();e.util.base64Encode=i;e.util.base64Decode=j;e.util.base64UrlEncode=function(a){var c,a=i(a);c=a.indexOf("=");-1!==c&&(a=a.slice(0,c));a=a.replace(/\+/g,"-");return a=a.replace(/\//g,"_")};e.util.base64UrlDecode=function(a){var c;
c=a.length%4;0!==c&&(a+=Array(5-c).join("="));a=a.replace(/-/g,"+");a=a.replace(/_/g,"/");return j(a)};e.util.ModalDialog=k}).call(this);(function(){var h,k,e,j,i,c,a=function(a,b){return function(){return a.apply(b,arguments)}},r=Object.prototype.hasOwnProperty,f=function(a,b){function c(){this.constructor=a}for(var g in b)r.call(b,g)&&(a[g]=b[g]);c.prototype=b.prototype;a.prototype=new c;a.__super__=b.prototype;return a};i="undefined"!==typeof exports&&null!==exports?exports:this;j=i.NotebookJS=null!=(c=i.NotebookJS)?c:{};e=function(c){function b(){this.destroyAll=a(this.destroyAll,this);this.saveAll=a(this.saveAll,this);this.stop=
a(this.stop,this);this.start=a(this.start,this);this.cellChanged=a(this.cellChanged,this);this.cellAdded=a(this.cellAdded,this);this.cellsFetched=a(this.cellsFetched,this);this.serialize=a(this.serialize,this);this.readyCells=a(this.readyCells,this);this.initialize=a(this.initialize,this);this.defaults=a(this.defaults,this);b.__super__.constructor.apply(this,arguments)}f(b,c);b.prototype.defaults=function(){return{title:"untitled",language:"Javascript",state:null,pendingSaves:!1,engineUrl:null}};
b.prototype.initialize=function(){"running"===this.get("state")&&"browser://"===this.get("engineUrl")&&this.set({state:null,engineUrl:null});this.cells=new k;this.cells.on("add",this.cellAdded);this.cells.on("change",this.cellChanged);this.cells.on("remove",this.cellChanged);this.cells.on("fetch",this.cellsFetched);return this.engines=null};b.prototype.readyCells=function(){return this.cells.localStorage=new Store("cells-"+this.get("id"))};b.prototype.serialize=function(){var a;a=this.toJSON();a.cells=
this.cells.toJSON();return JSON.stringify(a,null,2)};b.prototype.cellsFetched=function(a){return a.each(function(a){return a.engines=this.engines})};b.prototype.cellAdded=function(a){a.engines=this.engines;return this.set({pendingSaves:!0})};b.prototype.cellChanged=function(){return this.set({pendingSaves:!0})};b.prototype.start=function(){var a=this;this.set({state:"running"});this.set({engineUrl:"browser://"});this.engines={code:new j.engines.Javascript,markdown:new j.engines.Markdown};return this.cells.each(function(b){return b.engines=
a.engines})};b.prototype.stop=function(){this.set({state:null});return this.engines=null};b.prototype.saveAll=function(){console.log("saving nb");this.save();this.cells.each(function(a){return a.save()});return this.set({pendingSaves:!1})};b.prototype.destroyAll=function(){this.cells.fetch({success:function(a){return a.each(function(a){return a.destroy()})}});return this.destroy()};return b}(Backbone.Model);i=function(a){function b(){b.__super__.constructor.apply(this,arguments)}f(b,a);b.prototype.model=
e;b.prototype.localStorage=new Store("notebook.js");return b}(Backbone.Collection);h=function(c){function b(){this.evalEnd=a(this.evalEnd,this);this.evalBegin=a(this.evalBegin,this);this.addOutput=a(this.addOutput,this);this.interrupt=a(this.interrupt,this);this.evaluate=a(this.evaluate,this);this.toggleInputFold=a(this.toggleInputFold,this);this.toggleType=a(this.toggleType,this);this.initialize=a(this.initialize,this);this.defaults=a(this.defaults,this);b.__super__.constructor.apply(this,arguments)}
f(b,c);b.prototype.tagName="li";b.prototype.defaults=function(){return{input:"",type:"code",inputFold:!1,output:null,position:null,error:null,state:null}};b.prototype.initialize=function(){if("javascript"===this.get("type"))return this.set({type:"code"})};b.prototype.toggleType=function(){"code"===this.get("type")?this.set({type:"markdown"}):this.set({type:"code"});return this.set({state:"dirty"})};b.prototype.toggleInputFold=function(){return this.set({inputFold:!this.get("inputFold")})};b.prototype.evaluate=
function(){if(null==this.engines)console.log("WARNING: evaluation called with no engines");else return this.set({output:null,error:null}),this.set({state:"evaluating"}),this.engines[this.get("type")].evaluate(this.get("input"),this)};b.prototype.interrupt=function(){if(null==this.engines)console.log("WARNING: interrupt called with no engines");else return this.addOutput("Interrupted","error"),this.engines[this.get("type")].interrupt(),this.set({state:null})};b.prototype.addOutput=function(a,b){var c;
c=this.get("output")||"";"markdown"===this.get("type")&&(b="markdown");return this.set({output:c.concat('<div class="'+b+'">'+a+"</div>")})};b.prototype.error=function(a){return this.addOutput(a,"error")};b.prototype.print=function(a){return this.addOutput(a,"print")};b.prototype.result=function(a){return this.addOutput(a,"print")};b.prototype.evalBegin=function(){};b.prototype.evalEnd=function(){return this.set({state:null})};return b}(Backbone.Model);k=function(c){function b(){this.comparator=a(this.comparator,
this);b.__super__.constructor.apply(this,arguments)}f(b,c);b.prototype.model=h;b.prototype.posJump=Math.pow(2,16);b.prototype.comparator=function(a,b){a=a.get("position");b=b.get("position");return a>b?1:a<b?-1:0};b.prototype.createAtEnd=function(){return this.create({position:this.length?this.at(this.length-1).get("position")+this.posJump:this.posJump})};b.prototype.createBefore=function(a){var b;b=this.indexOf(a);a=a.get("position");b=0===b?0:this.at(b-1).get("position");return this.create({position:(a+
b)/2})};return b}(Backbone.Collection);j.Notebook=e;j.Notebooks=i;j.Cell=h;j.Cells=k}).call(this);(function(){var h,k,e,j,i,c,a=function(a,b){return function(){return a.apply(b,arguments)}},r=Object.prototype.hasOwnProperty,f=function(a,b){function c(){this.constructor=a}for(var g in b)r.call(b,g)&&(a[g]=b[g]);c.prototype=b.prototype;a.prototype=new c;a.__super__=b.prototype;return a};i="undefined"!==typeof exports&&null!==exports?exports:this;i=i.NotebookJS=null!=(k=i.NotebookJS)?k:{};k=function(){function c(){this.handleMessage=a(this.handleMessage,this);this.error=a(this.error,this);this.print=
a(this.print,this);this.result=a(this.result,this);this.evalEnd=a(this.evalEnd,this);this.evalBegin=a(this.evalBegin,this)}c.prototype.evalBegin=function(){};c.prototype.evalEnd=function(){};c.prototype.result=function(){};c.prototype.print=function(){};c.prototype.error=function(){};c.prototype.handleMessage=function(){};return c}();h=function(){function c(){this.halt=a(this.halt,this);this.interrupt=a(this.interrupt,this);this.evaluate=a(this.evaluate,this)}c.prototype.evaluate=function(){};c.prototype.interrupt=
function(){};c.prototype.halt=function(){};return c}();e=function(c){function b(){this.evaluate=a(this.evaluate,this);b.__super__.constructor.apply(this,arguments)}f(b,c);b.prototype.evaluate=function(a,b){var c;try{if(b.evalBegin(),c=eval(a),null!=c)return b.result(c.toString())}catch(e){return console.log(e.message,e.stack),b.error(e.toString())}finally{b.evalEnd()}};return b}(h);j=function(c){function b(){this.evaluate=a(this.evaluate,this);b.__super__.constructor.apply(this,arguments)}f(b,c);
b.prototype.evaluate=function(a,b){var c,e;try{return b.evalBegin(),e=new Showdown.converter,c=e.makeHtml(a),b.result(c)}catch(d){return console.log(d.message),b.error(d.toString())}finally{b.evalEnd()}};return b}(h);h=function(c){function b(){this.halt=a(this.halt,this);this.interrupt=a(this.interrupt,this);this.handleMessage=a(this.handleMessage,this);this.evaluate=a(this.evaluate,this);this.worker=new Worker("/src/worker.js");this.worker.onmessage=this.handleMessage;this.inputId=0;this.handlers=
{}}f(b,c);b.prototype.evaluate=function(a,b){this.inputId+=1;this.handlers[this.inputId]=b;return this.worker.postMessage({src:a,id:this.inputId})};b.prototype.handleMessage=function(a){var b,c;c=a.data.inputId;b=this.handlers[c];switch(a.data.msg){case "log":return console.log(a.data.data);case "evalBegin":return b.evalBegin();case "evalEnd":return b.evalEnd(),this.handlers[c]=null;case "print":return b.print(a.data.data);case "result":return b.result(a.data.data);case "error":return b.error(a.data.data)}};
b.prototype.interrupt=function(){this.worker.terminate();this.worker=new Worker("/src/worker.js");return this.worker.onmessage=this.handleMessage};b.prototype.halt=function(){this.worker.terminate();return this.worker=null};return b}(h);c={};c.BaseHandler=k;c.JavascriptWindow=e;c.Markdown=j;c.Javascript=h;i.engines=c}).call(this);(function(){var h,k,e,j,i,c,a,r,f,l,b,p,g,n,s,d=function(a,b){return function(){return a.apply(b,arguments)}},t=Object.prototype.hasOwnProperty,q=function(a,b){function o(){this.constructor=a}for(var c in b)t.call(b,c)&&(a[c]=b[c]);o.prototype=b.prototype;a.prototype=new o;a.__super__=b.prototype;return a};_.templateSettings={interpolate:/\[\[=(.+?)\]\]/g,evaluate:/\[\[(.+?)\]\]/g};h="undefined"!==typeof exports&&null!==exports?exports:this;c=h.NotebookJS=null!=(s=h.NotebookJS)?s:{};f=function(a){var b,
o,c;o=$(window).scrollTop()+60;b=$(window).scrollTop()+$(window).height()-30;c=a.offset().top;return c+a.height()<=b&&c>=o};g=function(a){a=a.offset().top-90;return $(window).scrollTop(a)};p=function(a){a=a.offset().top+a.height()+60-$(window).height();return $("body").scrollTop(a)};h=function(a){function b(){this.generateToc=d(this.generateToc,this);this.typeset=d(this.typeset,this);this.share=d(this.share,this);this.saveToFile=d(this.saveToFile,this);this.mathjaxReady=d(this.mathjaxReady,this);
this.handleTocJump=d(this.handleTocJump,this);b.__super__.constructor.apply(this,arguments)}q(b,a);b.prototype.className="app";b.prototype.handleTocJump=function(a){window.e=a;if(a=$(a.target).attr("href"))return a=$("#"+a),g(a)};b.prototype.mathjaxReady=function(){return this.typeset()};b.prototype.saveToFile=function(a){var b,c;b=this.model.serialize();c=_.string.slugify(this.model.get("title"));$(a.target).attr("download",c+".notebook");return $(a.target).attr("href","data:application/json;charset=utf-8,"+
escape(b))};b.prototype.share=function(){var a,b;a=c.util.base64UrlEncode(this.model.serialize());b="http://"+location.host+"/#import/"+escape(a)+"/";a=_.template($("#share-notebook").html());return(new c.util.ModalDialog(a({url:b}))).element.find("input").focus().select()};b.prototype.typeset=function(){var a,b,c,m;prettyPrint();m=this.$("#notebook");b=0;for(c=m.length;b<c;b++)a=m[b],MathJax.Hub.Typeset(a);return this.$("#toc").html(this.generateToc())};b.prototype.generateToc=function(){var a;a=
$(document.createElement("div"));this.$(".cell").each(function(b,c){var m;m=$(document.createElement("div")).appendTo(a);m.addClass("toc-cell");m.attr("href",$(c).attr("id"));return $(c).find("h1, h2, h3").each(function(c,m){var d,e;e="title"+b+"_"+c;$(m).attr("id",e);d=$(document.createElement("div"));d.addClass(m.tagName);d.addClass("toc-entry");d.attr("href",e);d.html($(m).html());return a.append(d)})});return a};return b}(Backbone.View);r=function(a){function b(){this.renderCell=d(this.renderCell,
this);this.addAll=d(this.addAll,this);this.addOne=d(this.addOne,this);this.render=d(this.render,this);this.initialize=d(this.initialize,this);this.toggleEdit=d(this.toggleEdit,this);b.__super__.constructor.apply(this,arguments)}q(b,a);b.prototype.events={"click #toc":"handleTocJump","click #toggle-edit":"toggleEdit","click #save-to-file":"saveToFile","click #share-url":"share","dblclick #notebook":"toggleEdit"};b.prototype.toggleEdit=function(){return c.router.navigate(this.model.get("id")+"/edit/",
{trigger:!0})};b.prototype.initialize=function(){this.template=_.template($("#notebook-template").html());this.cellTemplate=_.template($("#cell-view-template").html());$(".container").append(this.render());this.cells=this.$(".cells");this.model.cells.fetch({success:this.addAll});if(c.mathjaxReady)return this.typeset()};b.prototype.render=function(){$(this.el).html(this.template());return this.el};b.prototype.addOne=function(a){return this.cells.append(this.renderCell(a))};b.prototype.addAll=function(a){return a.each(this.addOne)};
b.prototype.renderCell=function(a){a=a.toJSON();a.input=a.input.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return this.cellTemplate(a)};return b}(h);e=function(a){function b(){this.save=d(this.save,this);this.toggleEdit=d(this.toggleEdit,this);this.spawnKeypress=d(this.spawnKeypress,this);this.spawnCellAtEnd=d(this.spawnCellAtEnd,this);this.addAll=d(this.addAll,this);this.addOne=d(this.addOne,this);this.render=d(this.render,this);this.initialize=d(this.initialize,this);this.events=
d(this.events,this);b.__super__.constructor.apply(this,arguments)}q(b,a);b.prototype.events=function(){return{"click #toc":"handleTocJump","dblclick #spawner":"spawnCellAtEnd","keyup #spawner":"spawnKeypress","click #toggle-edit":"toggleEdit","click #save-to-file":"saveToFile","click #share-url":"share","click #save":"save"}};b.prototype.initialize=function(){this.template=_.template($("#notebook-template").html());$(".container").append(this.render());this.cells=this.$(".cells");this.model.cells.bind("add",
this.addOne,this);this.model.cells.bind("refresh",this.addAll,this);this.model.cells.fetch({success:this.addAll});if(c.mathjaxReady)return this.typeset()};b.prototype.render=function(){$(this.el).html(this.template());return this.el};b.prototype.addOne=function(a){var b,m;c.c=a;m=new k({model:a});b=m.render();a=this.model.cells.indexOf(a);0===a?this.cells.prepend(b):(a=this.model.cells.at(a-1),a=a.view,$(a.el).after(b));m.afterDomInsert();return m.focusInput()};b.prototype.addAll=function(a){return a.each(this.addOne)};
b.prototype.spawnCellAtEnd=function(){return this.model.cells.createAtEnd()};b.prototype.spawnKeypress=function(a){if(13===a.keyCode)return this.model.cells.createAtEnd();if(38===a.keyCode)return a=this.model.cells.length,this.model.cells.at(a-1).view.output.focus()};b.prototype.toggleEdit=function(){return c.router.navigate(this.model.get("id")+"/view/",{trigger:!0})};b.prototype.save=function(){this.model.save();this.model.cells.each(function(a){return a.save()});return this.model.set({pendingSaves:!1})};
return b}(h);k=function(a){function b(){this.resizeEditor=d(this.resizeEditor,this);this.inputChange=d(this.inputChange,this);this.toggle=d(this.toggle,this);this.spawnAbove=d(this.spawnAbove,this);this.remove=d(this.remove,this);this.interrupt=d(this.interrupt,this);this.destroy=d(this.destroy,this);this.evaluate=d(this.evaluate,this);this.setEditorHighlightMode=d(this.setEditorHighlightMode,this);this.focusCellBelow=d(this.focusCellBelow,this);this.focusCellAbove=d(this.focusCellAbove,this);this.blurOutput=
d(this.blurOutput,this);this.focusOutput=d(this.focusOutput,this);this.blurInput=d(this.blurInput,this);this.focusInput=d(this.focusInput,this);this.changeInputFold=d(this.changeInputFold,this);this.toggleInputFold=d(this.toggleInputFold,this);this.handleKeypress=d(this.handleKeypress,this);this.afterDomInsert=d(this.afterDomInsert,this);this.changeState=d(this.changeState,this);this.changeOutput=d(this.changeOutput,this);this.changeType=d(this.changeType,this);this.render=d(this.render,this);this.logev=
d(this.logev,this);this.initialize=d(this.initialize,this);this.events=d(this.events,this);b.__super__.constructor.apply(this,arguments)}q(b,a);b.prototype.tagName="li";b.prototype.events=function(){return{"keyup .spawn-above":"handleKeypress","dblclick .spawn-above":"spawnAbove","click .evaluate":"evaluate","click .delete":"destroy","click .toggle":"toggle","click .type":"toggle","click .fold-button":"toggleInputFold","dblclick .cell-output":"toggleInputFold",evaluate:"evaluate",toggle:"toggle",
"click .interrupt":"interrupt","keyup .cell-output":"handleKeypress","focus .cell-input":"focusInput","focus .cell-output":"focusOutput","blur .cell-input":"blurInput","blur .cell-output":"blurOutput"}};b.prototype.initialize=function(){this.template=_.template($("#cell-edit-template").html());this.model.bind("change:state",this.changeState,this);this.model.bind("change:type",this.changeType,this);this.model.bind("change:output",this.changeOutput,this);this.model.bind("change:inputFold",this.changeInputFold,
this);this.model.bind("destroy",this.remove,this);this.model.view=this;return this.editor=null};b.prototype.logev=function(a){return console.log("in ev",a)};b.prototype.render=function(){var a;null==this.editor&&(a=this.model.toJSON(),null==this.model.id&&(a.id=this.model.cid),$(this.el).html(this.template(a)),this.spawn=this.$(".spawn-above"),this.input=this.$(".cell-input"),this.output=this.$(".cell-output"),this.inputContainer=this.$(".ace-container"),this.type=this.$(".type"),this.intButton=this.$(".interrupt"),
this.evalButton=this.$(".evaluate"));return this.el};b.prototype.changeType=function(){this.setEditorHighlightMode();return this.type.html(this.model.get("type"))};b.prototype.changeOutput=function(){this.output.html(this.model.get("output"));if(c.mathjaxReady)return MathJax.Hub.Typeset(this.output[0])};b.prototype.changeState=function(){switch(this.model.get("state")){case "evaluating":return this.output.html("..."),$(this.el).addClass("eval-cell"),$(this.el).removeClass("dirty-cell");case "dirty":return $(this.el).addClass("dirty-cell");
case null:return $(this.el).removeClass("eval-cell")}};b.prototype.afterDomInsert=function(){var a,b=this;this.editor=ace.edit("input-"+(null!=this.model.id?this.model.id:this.model.cid));this.model.set({state:null});this.editor.getSession().setUseWrapMode(!0);this.editor.renderer.setShowGutter(!1);this.editor.renderer.setHScrollBarAlwaysVisible(!1);this.editor.renderer.setShowPrintMargin(!1);this.editor.setHighlightActiveLine(!1);this.$(".ace_sb").css({display:"none"});a=this.model.get("input");
Math.max(3-_.string.count(a,"\n"),0);this.editor.getSession().setValue(a+"\n");this.resizeEditor();this.editor.getSession().on("change",this.inputChange);this.setEditorHighlightMode();this.model.get("inputFold")&&this.changeInputFold();this.editor.commands.addCommand({name:"evaluate",bindKey:{win:"Ctrl-E",mac:"Command-E",sender:"editor"},exec:function(){return b.evaluate()}});this.editor.commands.addCommand({name:"toggleMode",bindKey:{win:"Ctrl-M",mac:"Command-M",sender:"editor"},exec:function(){return b.toggle()}});
this.editor.commands.addCommand({name:"interrupt",bindKey:{win:"Ctrl-C",mac:"Ctrl-C",sender:"editor"},exec:function(){return b.interrupt()}});this.editor.commands.addCommand({name:"golineup",bindKey:{win:"Up",mac:"Up|Ctrl-P",sender:"editor"},exec:function(a,c){var o;o=b.$(".ace_cursor");f(o)||g(o);return 0===a.getSession().getSelection().getCursor().row?(b.spawn.focus(),b.rogueKeyup=!0):a.navigateUp(c.times)}});this.editor.commands.addCommand({name:"golinedown",bindKey:{win:"Down",mac:"Down",sender:"editor"},
exec:function(a,c){var o,d;o=b.$(".ace_cursor");f(o)||p(o);d=a.getSession().getSelection().getCursor().row;o=b.editor.getSession().getDocument().getLength()-1;return d===o?(b.output.focus(),b.rogueKeyup=!0):a.navigateDown(c.times)}});return this.editor.commands.addCommand({name:"backspace",bindKey:{win:"Backspace",mac:"Backspace",sender:"editor"},exec:function(a){a=a.getSession();return 1===a.getLength()&&""===a.getValue()?b.destroy():b.editor.remove("left")}})};b.prototype.handleKeypress=function(a){var b,
c;if(!0===this.rogueKeyup)this.rogueKeyup=!1;else if(b=this.model.get("inputFold"),c=a.target.className,38===a.keyCode)switch(c){case "cell-output":return b?this.spawn.focus():this.focusInput("bottom");case "spawn-above":return this.focusCellAbove()}else if(40===a.keyCode)switch(c){case "cell-output":return this.focusCellBelow();case "spawn-above":return b?this.output.focus():this.focusInput("top")}else if(13===a.keyCode)switch(c){case "spawn-above":return this.spawnAbove();case "cell-output":return this.toggleInputFold()}};
b.prototype.toggleInputFold=function(){return this.model.toggleInputFold()};b.prototype.changeInputFold=function(){this.inputContainer.toggleClass("input-fold");this.$(".fold-button").toggleClass("input-fold");return this.$("hr").toggleClass("input-fold")};b.prototype.focusInput=function(a){$(this.el).addClass("active-cell");"top"===a?(this.editor.gotoLine(1),this.editor.focus()):"bottom"===a&&(this.editor.gotoLine(this.editor.getSession().getDocument().getLength()),this.editor.focus());if(null!=
this.editor)return this.editor.setHighlightActiveLine(!0),this.$(".ace_cursor-layer").show()};b.prototype.blurInput=function(){$(this.el).removeClass("active-cell");if(null!=this.editor)return this.editor.setHighlightActiveLine(!1),this.$(".ace_cursor-layer").hide()};b.prototype.focusOutput=function(){return $(this.el).addClass("active-cell")};b.prototype.blurOutput=function(){return $(this.el).removeClass("active-cell")};b.prototype.focusCellAbove=function(){var a;a=this.model.collection.at(this.model.collection.indexOf(this.model)-
1);if(null!=a)return a.view.output.focus()};b.prototype.focusCellBelow=function(){var a;a=this.model.collection.at(this.model.collection.indexOf(this.model)+1);return null!=a?a.view.spawn.focus():$("#spawner").focus()};b.prototype.setEditorHighlightMode=function(){var a;"code"===this.model.get("type")?a=require("ace/mode/javascript").Mode:"markdown"===this.model.get("type")&&(a=require("ace/mode/markdown").Mode);if(null!=a)return this.editor.getSession().setMode(new a)};b.prototype.evaluate=function(){this.model.set({input:this.editor.getSession().getValue()});
return this.model.evaluate()};b.prototype.destroy=function(){console.log("destroy");return this.model.destroy()};b.prototype.interrupt=function(){return this.model.interrupt()};b.prototype.remove=function(){return $(this.el).fadeOut("fast",$(this.el).remove)};b.prototype.spawnAbove=function(){return this.model.collection.createBefore(this.model)};b.prototype.toggle=function(){return this.model.toggleType()};b.prototype.inputChange=function(){this.model.set({state:"dirty"});return this.resizeEditor()};
b.prototype.resizeEditor=function(){var a,b;a=this.editor.renderer.$textLayer.getLineHeight();b=this.editor.getSession().getScreenLength();if(1===a)setTimeout(this.resizeEditor,200);else return this.$(".ace-container").height(20+a*b),this.editor.resize()};return b}(Backbone.View);j=function(a){function b(){this.mathjaxReady=d(this.mathjaxReady,this);this.loadFile=d(this.loadFile,this);this["new"]=d(this["new"],this);this.addNbs=d(this.addNbs,this);this.addNb=d(this.addNb,this);this.render=d(this.render,
this);this.initialize=d(this.initialize,this);b.__super__.constructor.apply(this,arguments)}q(b,a);b.prototype.className="app";b.prototype.events={"click #new-notebook-button":"new","change #load-file":"loadFile"};b.prototype.initialize=function(){this.template=_.template($("#index-template").html());$(".container").append(this.render());return this.addNbs()};b.prototype.render=function(){$(this.el).html(this.template());return this.el};b.prototype.addNb=function(a){return $("#notebooks").append(this.nbtemplate(a.toJSON()))};
b.prototype.addNbs=function(){this.nbtemplate=_.template($("#notebook-index-template").html());return c.notebooks.each(this.addNb)};b.prototype["new"]=function(){console.log("new");return c.router.navigate("new/",{trigger:!0})};b.prototype.loadFile=function(a){var b,a=a.target.files[0];b=new FileReader;b.onload=function(a){a=JSON.parse(a.target.result);a=l(a);return c.router.navigate(a.get("id")+"/view/",{trigger:!0})};return b.readAsText(a)};b.prototype.mathjaxReady=function(){};return b}(Backbone.View);
i=function(a){function b(){this.mathjaxReady=d(this.mathjaxReady,this);this.create=d(this.create,this);this.render=d(this.render,this);this.initialize=d(this.initialize,this);b.__super__.constructor.apply(this,arguments)}q(b,a);b.prototype.className="app";b.prototype.events={"click #create":"create"};b.prototype.initialize=function(){this.template=_.template($("#new-notebook-form").html());return $(".container").append(this.render())};b.prototype.render=function(){$(this.el).html(this.template());
return this.el};b.prototype.create=function(){var a;a=this.$("input").val();if(""!==a)return a=c.notebooks.create({title:a},{wait:!0}),a.readyCells(),a.cells.create({position:a.cells.posJump}),c.router.navigate(a.get("id")+"/edit/",{trigger:!0})};b.prototype.mathjaxReady=function(){};return b}(Backbone.View);a=function(a){function b(){this.onbeforeunload=d(this.onbeforeunload,this);this["import"]=d(this["import"],this);this.loadUrl=d(this.loadUrl,this);this.index=d(this.index,this);this["new"]=d(this["new"],
this);this["delete"]=d(this["delete"],this);this.view=d(this.view,this);this.edit=d(this.edit,this);this.getNotebook=d(this.getNotebook,this);this.removeView=d(this.removeView,this);this.unmatched=d(this.unmatched,this);b.__super__.constructor.apply(this,arguments)}q(b,a);b.prototype.routes={":nb/edit/":"edit",":nb/view/":"view",":nb/delete/":"delete","load/*url":"loadUrl","new/":"new","import/*data/":"import","":"index"};b.prototype.initialize=function(){return this.bind("all",this._trackPageview)};
b.prototype._trackPageview=function(){var a;if("undefined"!==typeof _gaq&&null!==_gaq)return a=Backbone.history.getFragment(),console.log("pageview","/"+a),_gaq.push(["_trackPageview","/"+a])};b.prototype.unmatched=function(a){return console.log(a)};b.prototype.removeView=function(){var a,b;b=c.app;null!=b&&b.remove();if(null!=c.nb)return a=c.nb,a.saveAll(),null!=b&&(a.off(null,null,b),a.cells.off(null,null,b)),a.cells.each(function(a){if(a.view!=null){a.view=null;return a.off(null,null,a.view)}}),
c.nb=null};b.prototype.getNotebook=function(a){a=c.notebooks.get(a);a.readyCells();return c.nb=a};b.prototype.edit=function(a){this.removeView();a=this.getNotebook(a);c.app=new e({model:a});n(a.get("title")+" (Editing)");if(null==a.get("running"))return a.start()};b.prototype.view=function(a){this.removeView();a=this.getNotebook(a);n(a.get("title")+" (Viewing)");return c.app=new r({model:a})};b.prototype["delete"]=function(a){confirm("You really want to delete that?")&&(a=this.getNotebook(a),a.destroyAll(),
c.nb=null);return c.router.navigate("",{trigger:!0,replace:!0})};b.prototype["new"]=function(){this.removeView();return c.app=new i};b.prototype.index=function(){this.removeView();n("");return c.app=new j};b.prototype.loadUrl=function(a){return $.getJSON(a,function(a){a=l(a);return c.router.navigate(a.get("id")+"/view/",{trigger:!0,replace:!0})})};b.prototype["import"]=function(a){a=JSON.parse(c.util.base64UrlDecode(a));a=l(a);return c.router.navigate(a.get("id")+"/view/",{trigger:!0,replace:!0})};
b.prototype.onbeforeunload=function(){null!=c.nb&&c.nb.saveAll();if(_.any(c.notebooks.map(function(a){return"running"===a.get("state")})))return"You have running notebooks, are you sure?"};return b}(Backbone.Router);n=function(a){return $("#title").html(a)};l=function(a){var b,d,e,f,g,h;d=a.cells;delete a.cells;a.title=a.title;try{if(c.notebooks.get(a.id))throw"duplicate notebook";e=c.notebooks.create(a);e.readyCells();f=function(a){return e.cells.create(a)};g=0;for(h=d.length;g<h;g++)b=d[g],f(b);
return e}catch(i){return alert("Could not import notebook because it already exists.  try deleting"),console.log(i)}};b=function(){c.mathjaxReady=!0;return c.app.mathjaxReady()};$(document).ready(function(){c.notebooks=new c.Notebooks;c.notebooks.fetch();c.mathjaxReady=!1;c.router=new a;Backbone.history.start();MathJax.Hub.Register.StartupHook("End",b);return window.onbeforeunload=c.router.onbeforeunload})}).call(this);
